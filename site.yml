# Install on CentOS 6+7
---
#============================================================================== all
# do the common installed stuff first so handlers for it run 
# before a node-specific role is run with it's own handlers
#
- hosts: all
  become: true
  # check_mode: yes  # yes=dry-run
  roles:
    - common

#============================================================================== gl1
- hosts: gl1
  become: true
#============================================================================== gl1
  pre_tasks:
    - name: install epel-release
      yum: 
        name: epel-release
        state: installed 
        update_cache: yes

  tasks:
    - name: install nginx
      yum: 
        name: nginx
        state: installed 
        update_cache: yes
      register: nginx_installed
    # - debug: var=nginx_installed

    - name: update nginx index.html
      replace: 
        path: /usr/share/nginx/html/index.html
        regexp: '<strong>nginx</strong> on Fedora'
        replace: '<strong>nginx</strong> on {{ ansible_hostname }}'
        backup: yes

    - name: start and enable nginx
      service: 
        name: nginx 
        state: started 
        enabled: yes
      register: nginx_started
    # - debug: var=nginx_started

#============================================================================== gl2
- hosts: gl2
  become: true
  #  submodule git@github.com:geerlingguy/ansible-role-apache.git
  roles:
    - role: gerringguy.apache
      vars:
        apache_listen_port: 8080
        apache_vhosts:
        - servername: "{{ ansible_hostname }}"
          documentroot: /var/www/html
          extra_parameters: |
            RewriteCond %{HTTP_HOST} !^www\. [NC]
            RewriteRule ^(.*)$ http://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

  tasks:
    - name: enhance welcome message
      replace:
        path: /usr/share/httpd/noindex/index.html
        regexp: '<h1>(Testing 123..)</h1>'
        replace: '<h1>\1<br>on {{ ansible_hostname }}</h1>'
        backup: yes

#============================================================================== lbr
- hosts: lbr
  become: true
  roles:
  - haproxy
